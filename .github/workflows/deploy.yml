name: Deploy Backend to EC2

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
    types: [ closed ]

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' || (github.event.pull_request.merged == true)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Add EC2 to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
        
    - name: Deploy to EC2
      run: |
        ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          set -e
          
          echo "🚀 Starting deployment at $(date)"
          
          # Navigate to project directory
          cd ${{ secrets.EC2_PATH }}
          
          # Backup current state
          echo "📦 Creating backup..."
          sudo cp -r . ../backend_backup_$(date +%Y%m%d_%H%M%S) || true
          
          # Fix permissions BEFORE git operations
          echo "🔓 Fixing permissions for git operations..."
          sudo chown -R $USER:$USER .
          sudo chmod -R 755 .
          
          # Stash any local changes
          echo "💾 Stashing local changes..."
          git stash push -m "Auto-stash before deployment $(date)" || true
          
          # Pull latest changes
          echo "⬇ Pulling latest changes..."
          git fetch origin
          
          # Determine the correct branch and reset
          if git show-ref --verify --quiet refs/remotes/origin/master; then
            echo "Using master branch"
            git reset --hard origin/master
          elif git show-ref --verify --quiet refs/remotes/origin/main; then
            echo "Using main branch"  
            git reset --hard origin/main
          else
            echo "Error: Neither master nor main branch found"
            exit 1
          fi
          
          # Install/Update Composer dependencies
          echo "📚 Installing Composer dependencies..."
          composer install --no-dev --optimize-autoloader
          
          # Set proper permissions for Laravel directories BEFORE running artisan commands
          echo "🔒 Setting Laravel permissions..."
          sudo chown -R www-data:www-data storage bootstrap/cache
          sudo chmod -R 775 storage bootstrap/cache
          
          # Ensure log directory exists and has proper permissions
          sudo mkdir -p storage/logs
          sudo chown -R www-data:www-data storage/logs
          sudo chmod -R 775 storage/logs
          
          # Keep git ownership for deployment user
          sudo chown -R $USER:$USER .git
          
          # Clear caches (these don't require writing to files)
          echo "🧹 Clearing caches..."
          sudo -u www-data php artisan config:clear || php artisan config:clear
          sudo -u www-data php artisan cache:clear || php artisan cache:clear
          sudo -u www-data php artisan route:clear || php artisan route:clear
          sudo -u www-data php artisan view:clear || php artisan view:clear
          
          # Cache configurations (run as www-data to avoid permission issues)
          echo "💾 Caching configurations..."
          sudo -u www-data php artisan config:cache || php artisan config:cache
          sudo -u www-data php artisan route:cache || php artisan route:cache
          sudo -u www-data php artisan view:cache || php artisan view:cache
          
          # Run database migrations
          echo "🗃 Running migrations..."
          sudo -u www-data php artisan migrate --force || php artisan migrate --force
          
          # Final permission fix
          echo "🔧 Final permission adjustments..."
          sudo chown -R www-data:www-data storage bootstrap/cache
          sudo chmod -R 775 storage bootstrap/cache
          
          # Restart services
          echo "🔄 Restarting services..."
          sudo systemctl reload nginx || true
          sudo systemctl restart php8.1-fpm || sudo systemctl restart php8.2-fpm || true
          
          echo "✅ Deployment completed successfully at $(date)"
        EOF
        
    - name: Deployment Status
      run: |
        echo "🎉 Deployment to EC2 completed!"
        echo "🕐 Deployment time: $(date)"
        echo "🌍 Server: ${{ secrets.EC2_HOST }}"